name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build # Isso gera dist/public/index.html etc.

      - name: Copy files to VPS via SCP
        uses: appleboy/scp-action@master # Ou uma versão específica
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USERNAME }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          # Importante: fonte e destino baseados na saída do seu build
          source: "dist/public/" # Copia o CONTEÚDO de dist/public
          target: "${{ secrets.VPS_TARGET_PATH }}/dist" # Destino na VPS para ser /var/www/ebook.gestolize.com.br/dist
          # Se VPS_TARGET_PATH é /var/www/ebook.gestolize.com.br
          # E seu Nginx serve de /var/www/ebook.gestolize.com.br/dist
          # Então o conteúdo de dist/public/ do runner deve ir para /var/www/ebook.gestolize.com.br/dist/ na VPS

      - name: Execute commands on VPS
        uses: appleboy/ssh-action@master # Ou uma versão específica
        with:
          host: ${{ secrets.VPS_SSH_HOST }}
          username: ${{ secrets.VPS_SSH_USERNAME }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "--- Files should be copied to ${{ secrets.VPS_TARGET_PATH }}/dist ---"
            ls -lath ${{ secrets.VPS_TARGET_PATH }}/dist/
            echo "--- Changing permissions ---"
            sudo chown -R www-data:www-data ${{ secrets.VPS_TARGET_PATH }}/dist
            sudo find ${{ secrets.VPS_TARGET_PATH }}/dist -type d -exec chmod 755 {} \;
            sudo find ${{ secrets.VPS_TARGET_PATH }}/dist -type f -exec chmod 644 {} \;
            echo "--- Restarting Nginx ---"
            sudo systemctl restart nginx
            echo "Nginx restarted. Deployment complete!"
